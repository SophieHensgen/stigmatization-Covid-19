---
title: "Analysis"
author: "Sophie Hensgen"
date: "5/28/2021"
output: html_document
---

```{r setup, include=FALSE}
library(readr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidyr)
library(data.table)
library(sem)
library(reshape2)
library(xtable)
library(psych)
library(stargazer)
library(jtools)
library(plm)
library(lmtest)
library(Matrix)
library(lme4)
library(stargazer)
```

## Load Data Set

```{r Loading Data Set, include = FALSE}

df_stigma_wide <- read_csv("df_stigma_wide.csv")
df_stigma_long <- read_csv("df_stigma_long.csv")

```

## Make Factor Variables

```{r Factor Variables, include = FALSE}

## Variables with more than 2 factors

df_stigma_long$gen_infektion_v <- as.factor(df_stigma_long$gen_infektion_v)
df_stigma_long$gen_ethnie_v <- as.factor(df_stigma_long$gen_ethnie_v)
df_stigma_long$gen_schule <- as.factor(df_stigma_long$gen_schule)
df_stigma_long$gen_alter_v <- as.factor(df_stigma_long$gen_alter_v)
df_stigma_long$gen_beruf_v <- as.factor(df_stigma_long$gen_beruf_v)
df_stigma_long$gen_politik <- as.factor(df_stigma_long$gen_politik)

## Dummy Variables

df_stigma_long$gen_herkunft <- as.factor(df_stigma_long$gen_herkunft)
df_stigma_long$gen_impfung <- as.factor(df_stigma_long$gen_impfung)
df_stigma_long$gen_bund <- as.factor(df_stigma_long$gen_bund)
df_stigma_long$gen_sex_v <- as.factor(df_stigma_long$gen_sex_v)
df_stigma_long$gen_essential_v <- as.factor(df_stigma_long$gen_essential_v)
df_stigma_long$SD100 <- as.factor(df_stigma_long$SD100)

```

## Changing Reference Category

```{r Reference Category, include = FALSE}

## Variables with more than 2 factors

df_stigma_long$gen_infektion_v <- relevel(df_stigma_long$gen_infektion_v, ref = 3)
df_stigma_long$gen_politik <- relevel(df_stigma_long$gen_politik, ref = 2)
df_stigma_long$gen_schule <- relevel(df_stigma_long$gen_schule, ref = 3)
df_stigma_long$gen_beruf_v <- relevel(df_stigma_long$gen_beruf_v, ref = 3)

```

###########################################################################################################################################
##                                                                                                                                       ##
##                                                 Regression - Random Intercept                                                         ##
##                                                                                                                                       ##
###########################################################################################################################################

## Cluster Robust Standard Error Test

```{r Cluster Robust Standard Error Test, include = FALSE}

## Random Intercept Model - SDS Shortterm

ranin_short_m1 <-  lmer(gen_sds_shortterm ~ 1 + (1 | id), data = df_stigma_long)
ranin_short_m2 <-  lmer(gen_sds_shortterm ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + (1 | id), data = df_stigma_long)
ranin_short_m3 <-  lmer(gen_sds_shortterm  ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + SD100 + SD200 + I(SD200^2) + gen_bund + gen_schule + gen_herkunft + (1 | id), data = df_stigma_long)
ranin_short_m4 <-  lmer(gen_sds_shortterm  ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + SD100 + SD200 + I(SD200^2) + gen_bund + gen_schule + gen_herkunft + gen_politik + gen_situation + gen_mc_largegroups + gen_mc_smallgroups + gen_mc_bars + gen_mc_none + gen_impfung + (1 | id), data = df_stigma_long)
ranin_short_m5 <-  lmer(gen_sds_shortterm  ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + SD100 + SD200 + I(SD200^2) + gen_bund + gen_schule + gen_herkunft + gen_politik + gen_situation + gen_mc_largegroups + gen_mc_smallgroups + gen_mc_bars + gen_mc_none + gen_impfung + gen_infektion_v*gen_alter_v + gen_infektion_v*gen_beruf_v + gen_infektion_v*gen_ethnie_v + (1 | id), data = df_stigma_long)

```

```{r Cluster Robust Standard Error Test, include = FALSE}

## Random Intercept Model - SDS LongTerm

ranin_long_m1 <-  lmer(gen_sds_longterm ~ 1 + (1 | id), data = df_stigma_long)
ranin_long_m2 <-  lmer(gen_sds_longterm ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + (1 | id), data = df_stigma_long)
ranin_long_m3 <-  lmer(gen_sds_longterm  ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + SD100 + SD200 + I(SD200^2) + gen_bund + gen_schule + gen_herkunft + (1 | id), data = df_stigma_long)
ranin_long_m4 <-  lmer(gen_sds_longterm  ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + SD100 + SD200 + I(SD200^2) + gen_bund + gen_schule + gen_herkunft + gen_politik + gen_situation + gen_mc_largegroups + gen_mc_smallgroups + gen_mc_bars + gen_mc_none + gen_impfung + (1 | id), data = df_stigma_long)
ranin_long_m5 <-  lmer(gen_sds_longterm  ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + SD100 + SD200 + I(SD200^2) + gen_bund + gen_schule + gen_herkunft + gen_politik + gen_situation + gen_mc_largegroups + gen_mc_smallgroups + gen_mc_bars + gen_mc_none + gen_impfung + gen_infektion_v*gen_alter_v + gen_infektion_v*gen_beruf_v + gen_infektion_v*gen_ethnie_v + (1 | id), data = df_stigma_long)

```

```{r Table for LaTeX, include = FALSE}

## Table for LaTeX
 stargazer(ranin_short_m1, ranin_short_m2, ranin_short_m3, ranin_short_m4, ranin_short_m5,ranin_long_m1, ranin_long_m2, ranin_long_m3, ranin_long_m4, ranin_long_m5, 
       title = "Regression Table - Random Intercept Model",
       label="tab2",
       #covariate.labels = c("Infektion", "Female", "Age","Age Squared", "Schulausbildung", "Staatsangehörigkeit", "Politische Einstellung"), 
       #dep.var.labels   = c("Social Distance", "Short Term - Social Distance", "Long Term - Social Distance"), 
       #table.placement = "H",
       column.labels = c("M1", "M2", "M3"),
       model.numbers = FALSE,
       header=FALSE, 
       font.size= "footnotesize", 
       column.sep.width = "-5pt", 
       keep.stat = c("n", "ll", "aic", "bic"))
```
###########################################################################################################################################
##                                                                                                                                       ##
##                                                 Test - Cluster Robust Standard Error Test                                             ##
##                                                                                                                                       ##
###########################################################################################################################################

## Cluster Robust Standard Error Test

```{r Cluster Robust Standard Error Test, include = FALSE}

## Cluster Robust Standard Error Test
m1 <- lm(gen_sds ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_politik, data = df_stigma_long)
pm1 <- plm(gen_sds ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_politik, data = df_stigma_long, model = "pooling", index = "vignr")

# compute Stata like df-adjustment
G <- length(unique(df_stigma_long$vignr))
N <- length(df_stigma_long$vignr)
dfa <- (G/(G - 1)) * (N - 1)/pm1$df.residual
 
# display with cluster VCE and df-adjustment
firm_c_vcov <- dfa * vcovHC(pm1, type = "HC0", cluster = "group", adjust = T)
coeftest(pm1, vcov = firm_c_vcov)

#waldtest(pm1, vcov = firm_c_vcov, test = "F")

## Random Intercept Model

gpa_mixed <-  lmer(gen_sds ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_politik + (1 | vignr), data = df_stigma_long)
summary(gpa_mixed)

 stargazer(m1, pm1, gpa_mixed, 
       title = "Regression Table - Linear Regression",
       label="tab1",
       #covariate.labels = c("Infektion", "Female", "Age","Age Squared", "Schulausbildung", "Staatsangehörigkeit", "Politische Einstellung"), 
       #dep.var.labels   = c("Social Distance", "Short Term - Social Distance", "Long Term - Social Distance"), 
       #table.placement = "H",
       #column.labels = c("M1"),
       model.numbers = FALSE,
       header=FALSE, 
       font.size= "footnotesize", 
       column.sep.width = "-5pt", 
       keep.stat = c("rsq", "n", "ll", "lr", "aic", "bic"))
```


```{r Comparison different Models, include = FALSE}

## Cluster Robust Standard Error Test
m1 <- lm(gen_sds ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_infektion_v*gen_alter_v + gen_infektion_v*gen_beruf_v + gen_infektion_v*gen_ethnie_v, data = df_stigma_long)
pm1 <- plm(gen_sds ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_infektion_v*gen_alter_v + gen_infektion_v*gen_beruf_v + gen_infektion_v*gen_ethnie_v, data = df_stigma_long, model = "pooling", index = "vignr")

## Random Intercept Model

gpa_mixed <-  lmer(gen_sds ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_infektion_v*gen_alter_v + gen_infektion_v*gen_beruf_v + gen_infektion_v*gen_ethnie_v + (1 | vignr), data = df_stigma_long)
summary(gpa_mixed)

 stargazer(m1, pm1, gpa_mixed, 
       title = "Regression Table - Linear Regression",
       label="tab1",
       #covariate.labels = c("Infektion", "Female", "Age","Age Squared", "Schulausbildung", "Staatsangehörigkeit", "Politische Einstellung"), 
       #dep.var.labels   = c("Social Distance", "Short Term - Social Distance", "Long Term - Social Distance"), 
       #table.placement = "H",
       #column.labels = c("M1"),
       model.numbers = FALSE,
       header=FALSE, 
       font.size= "footnotesize", 
       column.sep.width = "-5pt", 
       keep.stat = c("adj.rsq", "n"))
 
```


## Coef Plot Example

```{r Hypothesis 1 - Coef Plot}

## Short Term

plot_summs(ranin_short_m1, ranin_short_m2, ranin_short_m3, scale = TRUE, plot.distributions = FALSE)

## Long Term

plot_summs(ranin_long_m1, ranin_long_m2, ranin_long_m3, scale = TRUE, plot.distributions = FALSE)

## Comparison Short and Longterm M3

plot_summs(ranin_short_m3, ranin_long_m3, scale = TRUE, plot.distributions = FALSE)


```


## Test Interaction in Linear Model

```{r Test}

lm_test <- lm(gen_sds ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v, df_stigma_long)
lm_test_short <- lm(gen_sds_shortterm ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v, df_stigma_long)
lm_test_long <- lm(gen_sds_longterm ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v, df_stigma_long)

summary(lm_test)
summary(lm_test_short)
summary(lm_test_long)

lm_test_int <- lm(gen_sds ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_infektion_v*gen_alter_v + gen_infektion_v*gen_beruf_v + gen_infektion_v*gen_ethnie_v, df_stigma_long)
lm_test_short_int <- lm(gen_sds_shortterm ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_infektion_v*gen_alter_v + gen_infektion_v*gen_beruf_v + gen_infektion_v*gen_ethnie_v, df_stigma_long)
lm_test_long_int <- lm(gen_sds_longterm ~ gen_infektion_v + gen_alter_v + gen_beruf_v + gen_sex_v + gen_ethnie_v + gen_infektion_v*gen_alter_v + gen_infektion_v*gen_beruf_v + gen_infektion_v*gen_ethnie_v, df_stigma_long)

summary(lm_test_int)
summary(lm_test_short_int)
summary(lm_test_long_int)
```































